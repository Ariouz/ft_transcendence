<div>
    <!-- Error div -->
    <div id="tournamentErrorDiv">
        <h3 id="tournamentErrorTitle"></h3>
        <span id="tournamentErrorDetails"></span>
    </div>

    <h1>Lobby</h1>
    <h2>Host: </h2>
    <div>
        <h3>Participants <span><span id="tournamentParticipantsCount"></span>/8</span></h3>
        <table id="tournamentParticipantsList">
            <tr>
                <th>Id</th>
                <th>Displayname</th>
            </tr>
        </table>
    </div>
    <button onclick="leave()" id="tournamentLeaveButton" style="display: none;">Leave tournament</button>
    
    <!-- Host only -->
    <button onclick="destroyTournament()" id="tournamentDeleteButton" style="display: none;">Delete tournament</button> 
    <button onclick="startTournament()" id="tournamentLaunchButton" style="display: none;">Launch tournament</button>
</div>

<script src="../../js/tournaments/tournament_lobby.js"></script>
<script>

async function checkTournamentId()
    {
        let tournamentParams = new URLSearchParams(window.location.search);
        let tournamentId = tournamentParams.get("tid");

        if (tournamentId == undefined) {
            navigate("/tournament");
            return;
        }

        // Check if player participates
        let userParticipates = await doesPlayerParticipate(tournamentId);
        console.log("Participates: " + userParticipates);
        if (!userParticipates) {
            navigate("/tournament");
            return ;
        }

        // Check tournament state
        let tournamentState = await getTournamentState(tournamentId);
        console.log(tournamentState);
        if (tournamentState == "ongoing") {
            navigate(`/tournament/rounds/?tid=${tournamentId}`);
            return ;
        } else if (tournamentState == "finished") {
            navigate("/tournament");
            return ;
        }

        user_token = getCookie("session_token");
        if (!g_tournamentWebSocket)
            createTournamentWebSocket(tournamentId, user_token);

        console.log("All checks valid");
        await displayTournamentLobbyButtons(tournamentId);
        await loadTournamentParticipantsList(tournamentId);
    
    }

    async function destroyTournament()
    {
        let tournamentParams = new URLSearchParams(window.location.search);
        let tournamentId = tournamentParams.get("tid");

        if (tournamentId == undefined) {
            navigate("/tournament");
            return;
        }

        await deleteTournament(tournamentId);
    }

    async function leave()
    {
        let tournamentParams = new URLSearchParams(window.location.search);
        let tournamentId = tournamentParams.get("tid");

        if (tournamentId == undefined) {
            navigate("/tournament");
            return;
        }

        await leaveTournament(tournamentId);
    }

    async function startTournament()
    {
        let tournamentParams = new URLSearchParams(window.location.search);
        let tournamentId = tournamentParams.get("tid");

        if (tournamentId == undefined) {
            navigate("/tournament");
            return;
        }
        await launchTournament(tournamentId);
    }

    checkTournamentId();
</script>